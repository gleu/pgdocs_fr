<?xml version="1.0" encoding="UTF-8"?>
<refentry id="app-vacuumdb">
 <indexterm zone="app-vacuumdb">
  <primary>vacuumdb</primary>
 </indexterm>

 <refmeta>
  <refentrytitle><application>vacuumdb</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>vacuumdb</refname>
  <refpurpose>récupère l'espace inutilisé et, optionnellement, analyse une
   base de données <productname>PostgreSQL</productname></refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>vacuumdb</command>
   <arg rep="repeat"><replaceable>option_de_connexion</replaceable></arg>
   <arg rep="repeat"><replaceable>option</replaceable></arg>

   <arg choice="plain" rep="repeat">
    <arg choice="opt">
     <group choice="plain">
      <arg choice="plain"><option>--table</option></arg>
      <arg choice="plain"><option>-t</option></arg>
     </group>
     <replaceable>table</replaceable>
     <arg choice="opt">( <replaceable class="parameter">colonne</replaceable> [,...] )</arg>
    </arg>
   </arg>
   <arg><replaceable>nom_base</replaceable></arg>
  </cmdsynopsis>

  <cmdsynopsis>
   <command>vacuumdb</command>
   <arg rep="repeat"><replaceable>options_de_connexion</replaceable></arg>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
   <group choice="plain">
    <arg choice="plain"><option>--all</option></arg>
    <arg choice="plain"><option>-a</option></arg>
   </group>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1>
  <title>Description</title>

  <para>
   <application>vacuumdb</application> est un outil de nettoyage d'une base de
   données. <application>vacuumdb</application> peut également engendrer des
   statistiques internes utilisées par l'optimiseur de requêtes de
   <productname>PostgreSQL</productname>.
  </para>

  <para>
   <application>vacuumdb</application> est une surcouche de la commande <xref
   linkend="sql-vacuum"/>. Il n'y a pas de différence réelle entre exécuter
   des VACUUM et des ANALYZE sur les bases de données via cet outil et via
   d'autres méthodes pour accéder au serveur.
  </para>
 </refsect1>

 <refsect1>
  <title>Options</title>

  <para>
   <application>vacuumdb</application> accepte les arguments suivants sur la
   ligne de commande&nbsp;:

   <variablelist>
    <varlistentry>
     <term><option>-a</option></term>
     <term><option>--all</option></term>
     <listitem>
      <para>
       Nettoie toutes les bases de données.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option><optional>-d</optional> <replaceable class="parameter">nom_base</replaceable></option></term>
     <term><option><optional>--dbname=</optional><replaceable class="parameter">nom_base</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le nom de la base à nettoyer ou à analyser quand l'option
       <option>-a</option>/<option>--all</option> n'est pas utilisée. Si le
       nom de la base n'est pas fourni, il est lu à partir de la variable
       d'environnement <envar>PGDATABASE</envar>. Si elle n'est pas
       configurée, le nom de l'utilisateur pour la connexion est utilisé. Ce
       nom de base peut être remplacé par une <link
       linkend="libpq-connstring">chaîne de connexion</link>. Dans ce cas, les
       paramètres de la chaîne de connexion surchargeront toutes les options
       en ligne de commande conflictuelles.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--disable-page-skipping</option></term>
     <listitem>
      <para>
       Désactive l'utilisation de la Visibility Map permettant d'ignorer
       certains blocs.
      </para>
      <note>
       <para>
        Cette option est seulement disponible pour les serveurs exécutant
        <productname>PostgreSQL</productname> 9.6 et ultérieurs.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-e</option></term>
     <term><option>--echo</option></term>
     <listitem>
      <para>
       Affiche les commandes que <application>vacuumdb</application> engendre
       et envoie au serveur.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-f</option></term>
     <term><option>--full</option></term>
     <listitem>
      <para>
       Exécute un nettoyage <quote>complet</quote>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-F</option></term>
     <term><option>--freeze</option></term>
     <listitem>
      <para>
       <quote>Gèle</quote> agressivement les lignes.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-j <replaceable class="parameter">njobs</replaceable></option></term>
     <term><option>--jobs=<replaceable class="parameter">njobs</replaceable></option></term>
     <listitem>
      <para>
       Exécute les commandes VACUUM et/ou ANALYZE en parallèle en plaçant
       <replaceable class="parameter">njobs</replaceable> commandes
       simultanément. Cette option réduit la durée du traitement tout en
       augmentant la charge sur le serveur de bases de données.
      </para>

      <para>
       <application>vacuumdb</application> ouvrira <replaceable
       class="parameter">njobs</replaceable> connexions sur la base de
       données, donc assurez-vous que votre configuration du paramètre <xref
       linkend="guc-max-connections"/> est suffisamment élevée pour accepter
       toutes les connexions nécessaires.
      </para>

      <para>
       Notez que l'utilisation de ce mode avec l'option <option>-f</option>
       (<literal>FULL</literal>) pourrait causer des échecs de type deadlock
       si certains catalogues systèmes sont traités en parallèle.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--min-mxid-age <replaceable class="parameter">age_mxid</replaceable></option></term>
     <listitem>
      <para>
       Exécute les commandes VACUUM et ANALYZE sur les tables dont l'âge de
       l'identifiant multixact est d'au moins <replaceable
       class="parameter">age_mxid</replaceable>. Cette option est utile pour
       prioriser les tables à traiter pour prévenir un bouclage des
       identifiants multixact (voir la <xref
       linkend="vacuum-for-multixact-wraparound"/>).
      </para>

      <para>
       Aux fins de cette option, l'âge de l'identifiant multixact d'une
       relation est le plus grand âge de la relation principale et de la
       relation <acronym>TOAST</acronym> associée si cette dernière existe.
       Comme les commandes exécutées par <application>vacuumdb</application>
       traitera aussi la table <acronym>TOAST</acronym> de la relation si
       nécessaire, il n'est pas nécessaire de la considérer séparément.
      </para>

      <note>
       <para>
        Cette option est seulement utile pour les serveurs exécutant
        <productname>PostgreSQL</productname> 9.6 et ultérieurs.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--min-xid-age <replaceable class="parameter">age_xid</replaceable></option></term>
     <listitem>
      <para>
       Exécute les commandes VACUUM et ANALYZE sur les tables dont l'âge de
       l'identifiant de transaction est d'au moins <replaceable
       class="parameter">age_xid</replaceable>. Cette option est utile pour
       prioriser les tables à traiter pour prévenir un bouclage des
       identifiants de transaction (voir la <xref
       linkend="vacuum-for-multixact-wraparound"/>).
      </para>

      <para>
       Aux fins de cette option, l'âge de l'identifiant de transaction d'une
       relation est le plus grand âge de la relation principale et de la
       relation <acronym>TOAST</acronym> associée si cette dernière existe.
       Comme les commandes exécutées par <application>vacuumdb</application>
       traitera aussi la table <acronym>TOAST</acronym> de la relation si
       nécessaire, il n'est pas nécessaire de la considérer séparément.
      </para>

      <note>
       <para>
        Cette option est seulement utile pour les serveurs exécutant
        <productname>PostgreSQL</productname> 9.6 et ultérieurs.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-P <replaceable class="parameter">niveau_parallelisation</replaceable></option></term>
     <term><option>--parallel=<replaceable class="parameter">niveau_parallelisation</replaceable></option></term>
     <listitem>
      <para>
       Indique le niveau de parallélisation pour un <firstterm>vacuum
        parallélisé</firstterm>. Ceci permet au vacuum d'utiliser plusieurs
       CPU pour traiter les index. Voir <xref linkend="sql-vacuum"/>.
      </para>

      <note>
       <para>
        Cette option est seulement disponible pour les serveurs
        <productname>PostgreSQL</productname> version 13 et supérieures.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-q</option></term>
     <term><option>--quiet</option></term>
     <listitem>
      <para>
       N'affiche pas de message de progression.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--skip-locked</option></term>
     <listitem>
      <para>
       Ignore les relations qui ne peuvent pas immédiatement être
       verrouillées pour être traitées.
      </para>

      <note>
       <para>
        Cette option est seulement utile pour les serveurs exécutant
        <productname>PostgreSQL</productname> 12 et ultérieurs.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-t <replaceable class="parameter">table</replaceable> [ (<replaceable class="parameter">colonne</replaceable> [,...]) ]</option></term>
     <term><option>--table=<replaceable class="parameter">table</replaceable> [ (<replaceable class="parameter">colonne</replaceable> [,...]) ]</option></term>
     <listitem>
      <para>
       Ne nettoie ou n'analyse que la table <replaceable
       class="parameter">table</replaceable>. Des noms de colonnes peuvent
       être précisés en conjonction avec les options
       <option>--analyze</option> ou <option>--analyze-only</option>.
       Plusieurs tables peuvent être traitées par VACUUM en utilisant
       plusieurs fois l'option <option>-t</option>.
      </para>

      <tip>
       <para>
        Lorsque des colonnes sont indiquées, il peut être nécessaire
        d'échapper les parenthèses. (Voir les exemples plus bas.)
       </para>
      </tip>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-v</option></term>
     <term><option>--verbose</option></term>
     <listitem>
      <para>
       Affiche des informations détaillées durant le traitement.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-V</option></term>
     <term><option>--version</option></term>
     <listitem>
      <para>
       Affiche la version de <application>vacuumdb</application>, puis
       quitte.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-z</option></term>
     <term><option>--analyze</option></term>
     <listitem>
      <para>
       Calcule aussi les statistiques utilisées par le planificateur.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-Z</option></term>
     <term><option>--analyze-only</option></term>
     <listitem>
      <para>
       Calcule seulement les statistiques utilisées par le planificateur
       (donc pas de VACUUM).
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--analyze-in-stages</option></term>
     <listitem>
      <para>
       Calcule seulement les statistiques utilisées par le planificateur (donc
       pas de VACUUM), comme <option>--analyze-only</option>. Effectue
       plusieurs (pour le moment trois) étapes de calcul avec différents
       réglages de configuration afin de générer des statistiques utilisables
       plus rapidement.
      </para>

      <para>
       Cette option est utile pour calculer les statistiques d'une base qui
       vient d'être peuplée, que cela soit à partir d'une restauration de
       sauvegarde ou d'un <command>pg_upgrade</command>. Cette option tentera
       de créer quelques statistiques le plus rapidement possible, pour rendre
       la base de données utilisable, et ensuite produire les statistiques
       complètes durant les étapes suivantes.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-?</option></term>
     <term><option>--help</option></term>
     <listitem>
      <para>
       Affiche l'aide sur les arguments en ligne de commande de
       <application>vacuumdb</application>, puis quitte.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>

  <para>
   <application>vacuumdb</application> accepte aussi les arguments suivants
   comme paramètres de connexion&nbsp;:

   <variablelist>
    <varlistentry>
     <term><option>-h <replaceable class="parameter">hôte</replaceable></option></term>
     <term><option>--host=<replaceable class="parameter">hôte</replaceable></option></term>
     <listitem>
      <para>
       Indique le nom d'hôte de la machine qui héberge le serveur de bases de
       données. Si la valeur commence par une barre oblique (/), elle est
       utilisée comme répertoire pour la socket de domaine Unix.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-p <replaceable class="parameter">port</replaceable></option></term>
     <term><option>--port=<replaceable class="parameter">port</replaceable></option></term>
     <listitem>
      <para>
       Indique le port TCP ou le fichier local de socket de domaine Unix sur
       lequel le serveur attend les connexions.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-U <replaceable class="parameter">utilisateur</replaceable></option></term>
     <term><option>--username=<replaceable class="parameter">utilisateur</replaceable></option></term>
     <listitem>
      <para>
       Nom d'utilisateur pour la connexion.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-w</option></term>
     <term><option>--no-password</option></term>
     <listitem>
      <para>
       Ne demande jamais un mot de passe. Si le serveur en réclame un pour
       l'authentification et qu'un mot de passe n'est pas disponible d'une
       autre façon (par exemple avec le fichier <filename>.pgpass</filename>),
       la tentative de connexion échouera. Cette option peut être utile pour
       les scripts où aucun utilisateur n'est présent pour saisir un mot de
       passe.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-W</option></term>
     <term><option>--password</option></term>
     <listitem>
      <para>
       Force <application>vacuumdb</application> à demander un mot de passe
       avant la connexion à une base de données.
      </para>

      <para>
       Cette option n'est jamais obligatoire car
       <application>vacuumdb</application> demandera automatiquement un mot de
       passe si le serveur exige une authentification par mot de passe.
       Néanmoins, <application>vacuumdb</application> perdra une tentative de
       connexion pour trouver que le serveur veut un mot de passe. Dans
       certains cas, il est préférable d'ajouter l'option <option>-W</option>
       pour éviter la tentative de connexion.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--maintenance-db=<replaceable class="parameter">nom_base_maintenance</replaceable></option></term>
     <listitem>
      <para>
       Indique le nom de la base où se connecter pour récupérer la liste des
       bases pour lesquelles il faut exécuter un nettoyage via VACUUM. Cette
       option est intéressante quand l'option
       <option>-a</option>/<option>--all</option> est utilisée. Si cette
       option n'est pas ajoutée, la base <literal>postgres</literal> sera
       utilisée. Si cette base n'existe pas, la base
       <literal>template1</literal> sera utilisée. Le nom de la base peut être
       remplacé par une <link linkend="libpq-connstring">chaîne de
        connexion</link>. Dans ce cas, les paramètres de la chaîne de connexion
       surchargeront les options en ligne de commande conflictuelles. De plus,
       les paramètres de la chaîne de connexion autres que le nom de la base
       lui-même seront réutilisés lors de la connexion aux autres bases.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>
 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGDATABASE</envar></term>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      Paramètres de connexion par défaut.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><envar>PG_COLOR</envar></term>
    <listitem>
     <para>
      Indique s'il faut utiliser des couleurs dans les messages de diagnostic.
      Les valeurs possibles sont <literal>always</literal>,
      <literal>auto</literal>, <literal>never</literal>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Cet outil, comme la plupart des autres outils
   <productname>PostgreSQL</productname>, utilise aussi les variables
   d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
  </para>
 </refsect1>

 <refsect1>
  <title>Diagnostiques</title>

  <para>
   En cas de difficultés, il peut être utile de consulter <xref
   linkend="sql-vacuum"/> et <xref linkend="app-psql"/>, sections présentant
   les problèmes éventuels et les messages d'erreur.
  </para>

  <para>
   Le serveur de base de données doit fonctionner sur le serveur cible. Les
   paramètres de connexion éventuels et les variables d'environnement utilisés
   par la bibliothèque cliente <application>libpq</application> s'appliquent.
  </para>
 </refsect1>


 <refsect1>
  <title>Notes</title>

  <para>
   <application>vacuumdb</application> peut avoir besoin de se connecter
   plusieurs fois au serveur <productname>PostgreSQL</productname>. Afin
   d'éviter de saisir le mot de passe à chaque fois, on peut utiliser un
   fichier <filename>~/.pgpass</filename>. Voir <xref linkend="libpq-pgpass"/>
   pour plus d'informations.
  </para>
 </refsect1>

 <refsect1>
  <title>Exemples</title>

  <para>
   Pour nettoyer la base de données <literal>test</literal>&nbsp;:
   <screen><prompt>$ </prompt><userinput>vacuumdb test</userinput>
   </screen>
  </para>

  <para>
   Pour nettoyer et analyser une base de données nommée
   <literal>grossebase</literal>&nbsp;:
   <screen><prompt>$ </prompt><userinput>vacuumdb --analyze grossebase</userinput>
   </screen>
  </para>

  <para>
   Pour nettoyer la seule table <literal>foo</literal> dans une base de
   données nommée <literal>xyzzy</literal> et analyser la seule colonne
   <literal>bar</literal> de la table&nbsp;:
   <screen><prompt>$ </prompt><userinput>vacuumdb --analyze --verbose --table='foo(bar)' xyzzy</userinput>
   </screen>
  </para>

 </refsect1>

 <refsect1>
  <title>Voir aussi</title>

  <simplelist type="inline">
   <member><xref linkend="sql-vacuum"/></member>
  </simplelist>
 </refsect1>

</refentry>

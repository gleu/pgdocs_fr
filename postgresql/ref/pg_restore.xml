<?xml version="1.0" encoding="UTF-8"?>
<refentry id="app-pgrestore">
 <indexterm zone="app-pgrestore">
  <primary>pg_restore</primary>
 </indexterm>

 <refmeta>
  <refentrytitle><application>pg_restore</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_restore</refname>

  <refpurpose>
   restaure des bases de données <productname>PostgreSQL</productname> à partir
   d'archives créées par <application>pg_dump</application> ou
   <application>pg_dumpall</application>
  </refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_restore</command>
   <arg rep="repeat"><replaceable>option_connexion</replaceable></arg>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
   <arg choice="opt"><replaceable>nom_fichier</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pgrestore-description">
  <title>Description</title>

  <para>
   <application>pg_restore</application> est un outil permettant de restaurer une base
   de données ou une instance <productname>PostgreSQL</productname> à partir
   d'une archive créée par <xref linkend="app-pgdump"/> ou <xref
   linkend="app-pg-dumpall"/> dans l'un des formats non textuels. Il
   exécute les instructions nécessaires pour reconstruire la base de données ou
   l'instance dans
   l'état où elle se trouvait lors de l'export. Les fichiers d'archive
   permettent aussi à <application>pg_restore</application> d'être sélectif
   sur ce qui est restauré ou même de réordonner les éléments à restaurer. Les
   formats d'archive sont conçus pour être portables entre les architectures.
  </para>

  <para>
   <application>pg_restore</application> peut fonctionner selon deux modes. Si un
   nom de base de données est spécifié, <application>pg_restore</application>
   se connecte à cette base et restaure directement le contenu de l'archive
   dans celle-ci.
   Lors de la restauration à partir d'un export généré par <application>pg_dumpall</application>,
   chaque base de données est créée, puis la restauration est effectuée dans
   cette base.

   Sinon, si aucun nom de base de données n'est spécifié, un script contenant
   les commandes SQL nécessaires à la reconstruction de la base de données ou de
   l'instance est généré, puis écrit dans un fichier ou envoyé vers la sortie
   standard. Ce script est équivalent au format texte brut produit par
   <application>pg_dump</application> ou <application>pg_dumpall</application>.
   Certaines des options contrôlant la sortie sont donc similaires à celles de
   <application>pg_dump</application>.
  </para>

  <para>
   Évidemment, <application>pg_restore</application> ne peut pas restaurer des
   informations qui ne sont pas présentes dans le fichier d'archive.
   Par exemple, si l'archive a été créée avec l'option
   <quote>export des données sous forme de commandes
    <command>INSERT</command></quote>, alors <application>pg_restore</application>
   ne pourra pas charger les données en utilisant des instructions
   <command>COPY</command>.
  </para>
 </refsect1>

 <refsect1 id="app-pgrestore-options">
  <title>Options</title>

  <para>
   <application>pg_restore</application> accepte les options en ligne de commande
   suivantes.

   <variablelist>
    <varlistentry>
     <term><replaceable class="parameter">nom_fichier</replaceable></term>
     <listitem>
      <para>
       Spécifie l'emplacement du fichier d'archive (ou du répertoire pour une
       archive au format « directory ») à restaurer. S'il n'est pas spécifié,
       l'entrée standard est utilisée.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-a</option></term>
     <term><option>--data-only</option></term>
     <listitem>
      <para>
       Restaure seulement les données, pas les schémas (définitions des
       données) ou les statistiques. Les données des tables, les Large Objects,
       et les valeurs des séquences sont restaurées si elles sont présentes
       dans l'archive.
      </para>

      <para>
       Cette option est similaire à <option>--section=data</option> mais, pour
       des raisons historiques, elle n'est pas identique.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-c</option></term>
     <term><option>--clean</option></term>
     <listitem>
      <para>
       Avant de restaurer les objets de la base, lance des commandes SQL
       <command>DROP</command> pour supprimer tous les objets à restaurer.
       Cette option est utile pour surcharger une base existante. Si un
       des objets n'existe pas dans la base de destination, des messages
       d'erreurs, à ignorer, seront renvoyées sauf si l'option
       <option>--if-exists</option> est aussi indiquée.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-C</option></term>
     <term><option>--create</option></term>
     <listitem>
      <para>
       Crée la base de données avant de la restaurer. Si l'option
       <option>--clean</option> est aussi indiquée, supprime puis crée de
       nouveau la base de données cible avant de s'y connecter.
      </para>

      <para>
       Avec l'option <option>--create</option>, <application>pg_restore</application>
       restaure également le commentaire associé à la base de données, s'il a été
       défini, ainsi que toutes les variables de configuration spécifiques à cette
       base. Cela inclut notamment toutes les commandes <command>ALTER DATABASE ...
        SET ...</command> et <command>ALTER ROLE ... IN DATABASE ... SET
        ...</command> qui se réfèrent à cette base. Les droits d'accès (ACL) sur la base
       elle-même sont également restaurés, sauf si l'option <option>--no-acl</option> est
       spécifiée.
       L'option <option>--create</option> est requise lors de la restauration de
       plusieurs bases de données à partir d'une archive créée par <application>pg_dumpall</application>.
      </para>

      <para>
       Quand cette option est utilisée, la base de données indiquée avec
       <option>-d</option> est utilisée uniquement pour exécuter les commandes
       <command>DROP DATABASE</command> et <command>CREATE DATABASE</command> initiales.
       Toutes les données sont restaurées dans la base dont le nom est indiqué
       dans l'archive.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-d <replaceable
       class="parameter">nom_base</replaceable></option></term>
     <term><option>--dbname=<replaceable
       class="parameter">nom_base</replaceable></option></term>
     <listitem>
      <para>
       Se connecte à la base de données <replaceable
       class="parameter">nom_base</replaceable> et restaure directement dans
       la base de données. Ce nom de base peut être remplacé par une <link
       linkend="libpq-connstring">chaîne de connexion</link>. Dans ce cas, les
       paramètres de la chaîne de connexion surchargeront toutes les options
       en ligne de commande conflictuelles.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-e</option></term>
     <term><option>--exit-on-error</option></term>
     <listitem>
      <para>
       Quitte si une erreur est rencontrée lors de l'envoi des commandes SQL à
       la base de données. La valeur par défaut est de continuer et d'afficher
       le nombre d'erreurs à la fin de la restauration.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-f <replaceable>nom_fichier</replaceable></option></term>
     <term><option>--file=<replaceable>filename</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le fichier en sortie pour le script généré ou pour la liste
       lorsqu'elle est utilisée avec <option>-l</option>. Utilisez
       <literal>-</literal> pour <systemitem>stdout</systemitem>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-F <replaceable class="parameter">format</replaceable></option></term>
     <term><option>--format=<replaceable class="parameter">format</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le format de l'archive. Il n'est pas nécessaire de le
       spécifier car <application>pg_restore</application> détermine le format
       automatiquement. Si spécifié, il peut s'agir de l'une des valeurs suivantes&nbsp;:

       <variablelist>
        <varlistentry>
         <term><literal>c</literal></term>
         <term><literal>custom</literal></term>
         <listitem>
          <para>
           L'archive est dans le format personnalisé de
           <application>pg_dump</application>.
          </para>
         </listitem>
        </varlistentry>

        <varlistentry>
         <term><literal>d</literal></term>
         <term><literal>directory</literal></term>
         <listitem>
          <para>
           L'archive est un répertoire
           (<foreignphrase>directory</foreignphrase>).
          </para>
         </listitem>
        </varlistentry>

        <varlistentry>
         <term><literal>t</literal></term>
         <term><literal>tar</literal></term>
         <listitem>
          <para>
           L'archive est une archive <command>tar</command>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-g</option></term>
     <term><option>--globals-only</option></term>
     <listitem>
      <para>
       Restaure uniquement les objets globaux (rôles et tablespaces), sans les bases de données.
      </para>
      <para>
       Cette option n'est pertinente que lors de la restauration à partir d'une
       archive créée avec <application>pg_dumpall</application>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-I <replaceable class="parameter">index</replaceable></option></term>
     <term><option>--index=<replaceable class="parameter">index</replaceable></option></term>
     <listitem>
      <para>
       Restaure uniquement la définition des index mentionnés. Plusieurs index
       peuvent être spécifiés en utilisant autant de fois l'option
       <option>-I</option>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-j <replaceable class="parameter">nombre-de-jobs</replaceable></option></term>
     <term><option>--jobs=<replaceable class="parameter">nombre-de-jobs</replaceable></option></term>
     <listitem>
      <para>
       Exécute les parties les plus consommatrices en temps de
       <application>pg_restore</application> &mdash; celles des chargements de
       données, créations d'index et créations de contraintes &mdash; en
       parallèle, utilisant jusqu'à <replaceable
       class="parameter">nombre-de-jobs</replaceable> sessions parallèles.
       Cette option peut réduire de beaucoup le temps pour restaurer une
       grosse base de données pour un serveur fonctionnant sur une machine
       multi-processeur. Cette option est ignorée lorsqu'un script est généré
       au lieu d'établir une connexion directe avec un serveur de bases de
       données.
      </para>

      <para>
       Chaque job est un processus ou un thread, suivant le système
       d'exploitation, et utilise une connexion séparée au serveur.
      </para>

      <para>
       La valeur optimale pour cette option dépend de la configuration
       matérielle du serveur, du client et du réseau. Les facteurs incluent le
       nombre de cœurs CPU et la configuration disque. Une bonne valeur de
       départ est le nombre de cœurs CPU du serveur, mais une valeur
       plus grande peut mener à des temps de restauration encore
       meilleurs dans de nombreux cas. Bien sûr, les valeurs trop hautes
       apporteront de moins bonnes performances.
      </para>

      <para>
       Seuls les formats d'archive personnalisé et répertoire sont supportés
       avec cette option. Le fichier en entrée doit être un fichier ou un
       répertoire classique (et non, par exemple, un « pipe » ou l'entrée standard).
       De plus, plusieurs jobs ne peuvent pas être utilisés conjointement avec
       l'option <option>--single-transaction</option>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-l</option></term>
     <term><option>--list</option></term>
     <listitem>
      <para>
       Liste le contenu de l'archive. Le résultat de cette opération peut être
       utilisé en entrée de l'option <option>-L</option>. Notez que, si vous
       utilisez des options de filtre telles que <option>-n</option> ou
       <option>-t</option> avec l'option <option>-l</option>, elles
       restreignent les éléments listés.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-L <replaceable
       class="parameter">fichier_liste</replaceable></option></term>
     <term><option>--use-list=<replaceable
       class="parameter">fichier_liste</replaceable></option></term>
     <listitem>
      <para>
       Ne restaure que les éléments présents dans le fichier
       <replaceable class="parameter">fichier_liste</replaceable>, et les
       restaure dans l'ordre où ils apparaissent dans ce fichier. Notez que si
       des options de filtre telles que <option>-n</option> ou
       <option>-t</option> sont utilisées avec <option>-L</option>, elles
       restreindront encore davantage les éléments restaurés.
      </para>

      <para>
       <replaceable class="parameter">fichier_liste</replaceable> est
       normalement créé en éditant la sortie d'une précédente opération
       <option>-l</option>. Les lignes peuvent être déplacées ou supprimées,
       et peuvent aussi être mises en commentaire en ajoutant un point-virgule
       (<literal>;</literal>) au début de la ligne. Voir ci-dessous pour des
       exemples.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-n <replaceable class="parameter">nom_schema</replaceable></option></term>
     <term><option>--schema=<replaceable class="parameter">nom_schema</replaceable></option></term>
     <listitem>
      <para>
       Restaure seulement les objets qui sont dans le schéma mentionné. Plusieurs
       schémas peuvent être spécifiés en utilisant autant de fois l'option
       <option>-n</option>. Elle peut être combinée avec l'option
       <option>-t</option> pour ne restaurer qu'une seule table.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-N <replaceable class="parameter">nom_schema</replaceable></option></term>
     <term><option>--exclude-schema=<replaceable class="parameter">nom_schema</replaceable></option></term>
     <listitem>
      <para>
       Ne pas restaurer les objets qui sont dans le schéma mentionné. Plusieurs
       schémas à exclure peuvent être spécifiés en utilisant autant de fois
       l'option <option>-N</option>.
      </para>

      <para>
       Lorsqu'à la fois <option>-n</option> et <option>-N</option> sont spécifiés
       pour le même nom de schéma, c'est l'option <option>-N</option> qui prévaut
       et le schéma est exclu.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-O</option></term>
     <term><option>--no-owner</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes permettant d'attribuer les objets restaurés
       à leur propriétaire d'origine. Par défaut,
       <application>pg_restore</application> génère des instructions
       <command>ALTER OWNER</command> ou <command>SET SESSION
        AUTHORIZATION</command> pour rétablir le propriétaire des éléments du
       schéma créés. Ces instructions échoueront sauf si la connexion initiale à
       la base de données est effectuée par un superutilisateur (ou par le même
       utilisateur que le propriétaire de tous les objets dans le script). Avec
       <option>-O</option>, n'importe quel nom d'utilisateur peut être utilisé
       pour la connexion initiale, et cet utilisateur deviendra propriétaire de
       tous les objets créés.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-P <replaceable class="parameter">nom_fonction(argtype [,
        ...])</replaceable></option></term>
     <term><option>--function=<replaceable
       class="parameter">nom_fonction(argtype [,
        ...])</replaceable></option></term>
     <listitem>
      <para>
       Restaure seulement la fonction mentionnée. Veillez à orthographier le nom
       de la fonction et ses arguments exactement comme ils apparaissent dans
       la table des matières de l'export. Plusieurs fonctions peuvent
       être spécifiées en utilisant autant de fois l'option <option>-P</option>.
       <option>-P</option>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-r</option></term>
     <term><option>--no-reconnect</option></term>
     <listitem>
      <para>
       Cette option est obsolète mais est toujours acceptée pour des raisons
       de compatibilité ascendante.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-s</option></term>
     <term><option>--schema-only</option></term>
     <listitem>
      <para>
       Restaure seulement le schéma (autrement dit, la définition des
       données), mais pas les données, à condition que cette définition soit
       présente dans l'archive.
      </para>

      <para>
       Cette option ne peut pas être utilisée avec <option>--data-only</option>
       ou <option>--statistics-only</option>. Elle est
       similaire, mais pas identique (pour des raisons historiques), à
       <option>--section=pre-data --section=post-data --no-statistics</option>.
      </para>

      <para>
       (Ne pas la confondre avec l'option <option>--schema</option> qui
       utilise le mot <quote>schema</quote> dans un contexte différent.)
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-S <replaceable
       class="parameter">nom_utilisateur</replaceable></option></term>
     <term><option>--superuser=<replaceable
       class="parameter">nom_utilisateur</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le nom d'utilisateur du superutilisateur à utiliser pour
       désactiver les triggers. Ceci est seulement nécessaire si
       <option>--disable-triggers</option> est utilisé.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-t <replaceable class="parameter">table</replaceable></option></term>
     <term><option>--table=<replaceable class="parameter">table</replaceable></option></term>
     <listitem>
      <para>
       Restaure la définition et/ou les données de la table mentionnée uniquement.
       Dans ce contexte, <quote>table</quote> inclut les vues, les vues
       matérialisées, les séquences et les tables distantes. Plusieurs tables
       peuvent être sélectionnées en utilisant autant de fois l'option
       <option>-t</option>. Cette option peut être combinée avec l'option
       <option>-n</option> pour sélectionner des tables d'un schéma particulier.
      </para>

      <note>
       <para>
        Lorsqu'on utilise l'option <option>-t</option>,
        <application>pg_restore</application> ne tente pas de restaurer les
        autres objets de la base de données dont la ou les tables sélectionnées
        pourraient dépendre. Par conséquent, il n'y a aucune garantie qu'une
        restauration d'une table spécifique dans une base vide réussira.
        </para>
      </note>

      <note>
       <para>
        Cette option ne se comporte pas de la même façon que l'option
        <option>-t</option> de <application>pg_dump</application>. Il n'existe
        actuellement aucun support pour la recherche avec des jokers dans
        <application>pg_restore</application>, ni la possibilité d'inclure un nom
        de schéma dans <option>-t</option>. De plus, tandis que l'option
        <option>-t</option> de <application>pg_dump</application> exporte également
        les objets dépendants (comme les index) des tables sélectionnées, celle de
        <application>pg_restore</application> n'inclut pas ces objets.
       </para>
      </note>

      <note>
       <para>
        Dans les versions de <productname>PostgreSQL</productname> antérieures
        à la 9.6, cette option ne correspondait qu'aux tables, et non aux
        autres types de relations.
       </para>
      </note>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-T <replaceable class="parameter">trigger</replaceable></option></term>
     <term><option>--trigger=<replaceable class="parameter">trigger</replaceable></option></term>
     <listitem>
      <para>
       Restaure uniquement le trigger mentionné. Plusieurs triggers peuvent être
       spécifiés en utilisant autant de fois l'option <option>-T</option>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-v</option></term>
     <term><option>--verbose</option></term>
     <listitem>
      <para>
       Spécifie le mode verbeux. Ceci aura pour conséquence que
       <application>pg_restore</application> affichera des commentaires
       détaillés sur les objets, ainsi que les heures de début et de fin dans
       le fichier en sortie, et des messages de progression sur la sortie des
       erreurs. Répéter cette option cause l'apparition de messages
       de débogage supplémentaires sur la sortie des erreurs.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-V</option></term>
     <term><option>--version</option></term>
     <listitem>
      <para>
       Affiche la version de <application>pg_restore</application>, puis
       quitte.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-x</option></term>
     <term><option>--no-privileges</option></term>
     <term><option>--no-acl</option></term>
     <listitem>
      <para>
       Empêche la restauration des droits d'accès (commandes grant/revoke).
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-1</option></term>
     <term><option>--single-transaction</option></term>
     <listitem>
      <para>
       Exécute la restauration en une seule transaction (autrement dit, toutes
       les commandes de restauration sont placées entre un
       <command>BEGIN</command> et un <command>COMMIT</command>). Ceci assure à
       l'utilisateur que soit toutes les commandes réussissent, soit aucun
       changement n'est appliqué. Cette option implique
       <option>--exit-on-error</option>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--disable-triggers</option></term>
     <listitem>
      <para>
       Cette option n'est pertinente que lors d'une restauration sans schéma.
       Elle demande à <application>pg_restore</application> d'exécuter
       des commandes pour désactiver temporairement les triggers sur les
       tables cibles pendant que les données sont rechargées. Utilisez ceci si
       vous avez des vérifications d'intégrité référentielle sur les tables
       que vous ne voulez pas appeler lors du rechargement des données.
      </para>

      <para>
       Actuellement, les commandes émises pour
       <option>--disable-triggers</option> doivent être exécutées par un
       superutilisateur. Donc, vous devriez aussi spécifier un nom de
       superutilisateur avec <option>-S</option> ou, de préférence, lancer
       <application>pg_restore</application> en tant que superutilisateur
       <productname>PostgreSQL</productname>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--enable-row-security</option></term>
     <listitem>
      <para>
       Cette option n'est pertinente que lors de la restauration du contenu d'une
       table disposant de la sécurité au niveau ligne (RLS). Par défaut,
       <application>pg_restore</application> configurera <xref
       linkend="guc-row-security"/> à off, pour s'assurer que toutes les
       données sont restaurées dans la table. Si l'utilisateur n'a pas les
       droits nécessaires pour contourner la sécurité au niveau ligne, alors
       une erreur est levée. Ce paramètre demande à
       <application>pg_restore</application> de configurer <xref
       linkend="guc-row-security"/> à on, permettant à l'utilisateur d'essayer
       de restaurer le contenu de la table avec la sécurité au niveau ligne
       activée. Ceci pourrait échouer si l'utilisateur n'a pas le droit
       d'insérer des lignes dans la table.
      </para>

      <para>
       Notez que cette option requiert aussi actuellement que la sauvegarde
       soit au format <command>INSERT</command> car <command>COPY
        FROM</command> n'est pas supportée par la sécurité au niveau ligne.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--exclude-database=<replaceable class="parameter">motif</replaceable></option></term>
     <listitem>
      <para>
       Ne restaure pas les bases de données dont le nom correspond au
       <replaceable class="parameter">motif</replaceable>.
       Plusieurs motifs peuvent être exclus en répétant plusieurs fois
       l'option <option>--exclude-database</option>.
       Le paramètre <replaceable class="parameter">motif</replaceable> est
       interprété comme un motif selon les mêmes règles que les commandes
       <literal>\d</literal> de <application>psql</application>
       (voir <xref linkend="app-psql-patterns"/>).
       Il est donc possible d'exclure plusieurs bases de données en utilisant
       des jokers dans le motif. Dans ce cas, prenez soin d'encadrer le motif de
       guillemets simples si nécessaire, pour empêcher le shell de les interpréter.
      </para>
      <para>
       Cette option n'est pertinente que lors de la restauration à partir d'une
       archive créée avec <application>pg_dumpall</application>.
      </para>
     </listitem>
    </varlistentry>

     <varlistentry>
      <term><option>--filter=<replaceable class="parameter">filename</replaceable></option></term>
      <listitem>
       <para>
        Spécifie un nom de fichier à partir duquel lire les motifs des objets
        à exclure ou à inclure lors de la restauration. Les motifs sont interprétés
        selon les mêmes règles que
        <option>-n</option>/<option>--schema</option> pour inclure les objets
        dans les schémas,
        <option>-N</option>/<option>--exclude-schema</option> pour exclure
        les objets dans les schémas,
        <option>-P</option>/<option>--function</option> pour restaurer les
        fonctions mentionnées, <option>-I</option>/<option>--index</option> pour
        restaurer les index mentionnés,
        <option>-t</option>/<option>--table</option> pour restaurer les
        tables mentionnées ou <option>-T</option>/<option>--trigger</option> pour
        restaurer les triggers. Pour lire depuis
        <literal>STDIN</literal>, utilisez <filename>-</filename> comme nom
        de fichier. L'option <option>--filter</option> peut être utilisée en
        même temps que les options listées ci-dessus pour inclure ou exclure
        des objets, et peut aussi être spécifiée plusieurs fois pour utiliser
        plusieurs fichiers de filtres.
       </para>

       <para>
        Le fichier liste un motif de base de données par ligne en respectant le
        format suivant&nbsp;:
<synopsis>
{ include | exclude } { function | index | schema | table | trigger } <replaceable class="parameter">MOTIF</replaceable>
</synopsis>
       </para>

       <para>
        Le premier mot clé indique si les objets correspondant au motif
        doivent être inclus ou exclus. Le deuxième mot clé précise le
        type d'objet à filtrer à l'aide du motif&nbsp;:
        <itemizedlist>
         <listitem>
          <para>
           <literal>function</literal>&nbsp;: fonctions, fonctionne comme
           l'option <option>-P</option>/<option>--function</option>. Ce
           mot clé peut seulement être utilisé avec le mot clé
           <literal>include</literal>.
          </para>
         </listitem>
         <listitem>
          <para>
           <literal>index</literal>&nbsp;: index, fonctionne comme l'option
           <option>-I</option>/<option>--indexes</option>. Ce mot clé peut
           seulement être utilisé avec le mot clé <literal>include</literal>.
          </para>
         </listitem>
         <listitem>
          <para>
           <literal>schema</literal>&nbsp;: schémas, fonctionne comme les
           options <option>-n</option>/<option>--schema</option> et
           <option>-N</option>/<option>--exclude-schema</option>.
          </para>
         </listitem>
         <listitem>
          <para>
           <literal>table</literal>&nbsp;: tables, fonctionne comme l'option
           <option>-t</option>/<option>--table</option>. Ce mot clé peut
           seulement être utilisé avec le mot clé <literal>include</literal>.
          </para>
         </listitem>
         <listitem>
          <para>
           <literal>trigger</literal>&nbsp;: triggers, fonctionne comme
           l'option <option>-T</option>/<option>--trigger</option>. Ce mot
           clé peut seulement être utilisé avec le mot clé
           <literal>include</literal>.
          </para>
         </listitem>
        </itemizedlist>
       </para>

       <para>
        Les lignes commençant avec <literal>#</literal> sont considérées
        comme des commentaires et, de ce fait, sont ignorées. Les
        commentaires peuvent aussi être placés à la suite d'une ligne de motif
        d'objet. Les lignes vides sont elles-aussi ignorées. Voir
        <xref linkend="app-psql-patterns"/> pour savoir comment réaliser
        l'échappement dans les motifs.
       </para>
      </listitem>
     </varlistentry>

    <varlistentry>
     <term><option>--if-exists</option></term>
     <listitem>
      <para>
       Utilise des commandes <literal>DROP ... IF EXISTS</literal> pour
       supprimer des objets dans le mode <option>--clean</option>. Cela
       permet de supprimer les erreurs <quote>does not exist</quote> qui
       seraient sinon renvoyées. Cette option n'est pas valide sauf si
       <option>--clean</option> est aussi spécifiée.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-comments</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les commentaires, même si
       l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-data</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les données, même si l'archive
       en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-data-for-failed-tables</option></term>
     <listitem>
      <para>
       Par défaut, les données de la table sont restaurées même si la commande
       de création de cette table a échoué (par exemple parce qu'elle existe
       déjà). Avec cette option, les données de cette table seront ignorées.
       Ce comportement est utile si la base cible contient déjà des données
       pour cette table. Par exemple, les tables supplémentaires des
       extensions de <productname>PostgreSQL</productname> comme
       <productname>PostGIS</productname> pourraient avoir déjà été créées et
       remplies sur la base cible&nbsp;; indiquer cette option empêche l'ajout
       de données dupliquées ou obsolètes.
      </para>

      <para>
       Cette option est seulement efficace lors de la restauration directe
       d'une base, pas lors de la réalisation d'une sortie de script SQL.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-policies</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les politiques de sécurité
       au niveau ligne, même si l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-publications</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les publications,
       même si l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-schema</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer le schéma (définitions des données),
       même si l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-security-labels</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les labels de sécurité,
       même si l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-statistics</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les statistiques,
       même si l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-subscriptions</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour restaurer les souscriptions, même si
       l'archive en contient.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-table-access-method</option></term>
     <listitem>
      <para>
       Ne génère pas les commandes pour sélectionner les méthodes d'accès aux
       tables. Avec cette option, tous les objets seront créés avec la méthode
       d'accès aux tables par défaut lors de la restauration.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--no-tablespaces</option></term>
     <listitem>
      <para>
       Ne sélectionne pas les tablespaces. Avec cette option, tous les objets
       seront créés dans le tablespace par défaut lors de la restauration.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--section=<replaceable class="parameter">nom_section</replaceable></option></term>
     <listitem>
      <para>
       Restaure seulement la section mentionnée. Le nom de la section peut être
       <option>pre-data</option>, <option>data</option> ou
       <option>post-data</option>. Cette option peut être spécifiée plus d'une
       fois pour sélectionner plusieurs sections. La valeur par défaut est
       toutes les sections.
      </para>

      <para>
       La section data contient toutes les données des tables ainsi que la
       définition des Large Objects. Les éléments post-data consistent en la
       définition des index, triggers, règles et contraintes (autres que les
       contraintes de vérification). Les éléments pre-data consistent en tous
       les autres éléments de définition.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--statistics-only</option></term>
     <listitem>
      <para>
       Restaure uniquement les statistiques, sans le schéma (définitions des données) ni les données.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--strict-names</option></term>
     <listitem>
      <para>
       Requiert que chaque qualificateur de schéma (<option>-n</option> /
       <option>--schema</option>) et table (<option>-t</option> /
       <option>--table</option>) corresponde à au moins un schéma ou une table
       présent dans le fichier à restaurer.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--transaction-size=<replaceable class="parameter">N</replaceable></option></term>
     <listitem>
      <para>
       Exécute la restauration sous forme d'une série de transactions, chacune
       traitant jusqu'à <replaceable class="parameter">N</replaceable>
       objets de la base de données. Cette option implique
       <option>--exit-on-error</option>.
      </para>
      <para>
       <option>--transaction-size</option> propose un choix intermédiaire
       entre le comportement par défaut (une transaction par commande SQL) et
       l'option <option>-1</option>/<option>--single-transaction</option>
       (une seule transaction pour tous les objets restaurés). Alors que
       <option>--single-transaction</option> a la surcharge la moins
       importante, cela pourrait se révéler peu pratique pour les grosses
       bases de données du fait du verrou pris par la transaction sur chaque
       objet restauré, risquant d'épuiser tout l'espace mémoire du serveur
       disponible pour les verrous. Utiliser <option>--transaction-size</option>
       avec une taille de quelques milliers d'objets offre quasiment les
       mêmes avantages en termes de performance tout en limitant la quantité de
       mémoire nécessaire pour les verrous.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--use-set-session-authorization</option></term>
     <listitem>
      <para>
       Génère des commandes <command>SET SESSION AUTHORIZATION</command> conformes
       au standard SQL au lieu des commandes <command>ALTER OWNER</command>
       pour définir le propriétaire des objets. Cela rend l'export
       plus conforme aux standards, mais selon l'historique des objets contenus
       dans l'archive, la restauration pourrait ne pas s'effectuer correctement.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--with-data</option></term>
     <listitem>
      <para>
       Génère les commandes pour restaurer les données, si l'archive en contient.
       C'est le comportement par défaut.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--with-schema</option></term>
     <listitem>
      <para>
       Génère les commandes pour restaurer le schéma (définitions des données),
       si l'archive en contient. C'est le comportement par défaut.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--with-statistics</option></term>
     <listitem>
      <para>
       Génère les commandes pour restaurer les statistiques, si l'archive en contient.
       C'est le comportement par défaut.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-?</option></term>
     <term><option>--help</option></term>
     <listitem>
      <para>
       Affiche l'aide sur les arguments en ligne de commande de
       <application>pg_restore</application>, puis quitte.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>

  <para>
   <application>pg_restore</application> accepte également les arguments
   en ligne de commande suivants pour les paramètres de connexion&nbsp;:

   <variablelist>
    <varlistentry>
     <term><option>-h <replaceable
       class="parameter">hôte</replaceable></option></term>
     <term><option>--host=<replaceable
       class="parameter">hôte</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le nom d'hôte de la machine sur laquelle le serveur de bases de
       données est en cours d'exécution. Si la valeur commence par une barre
       oblique (/), elle est interprétée comme le répertoire du socket de
       domaine Unix. Par défaut, la valeur est tirée de la variable
       d'environnement <envar>PGHOST</envar>, si elle est définie&nbsp;;
       sinon, une connexion via socket de domaine Unix est tentée.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-p <replaceable class="parameter">port</replaceable></option></term>
     <term><option>--port=<replaceable class="parameter">port</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le port TCP ou l'extension du fichier socket de domaine Unix
       sur lequel le serveur écoute les connexions. La valeur par défaut est
       celle de la variable d'environnement <envar>PGPORT</envar>, si elle est
       définie. Dans le cas contraire, il s'agit de la valeur fournie à la
       compilation.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-U
       <replaceable>nom_utilisateur</replaceable></option></term>
     <term><option>--username=<replaceable class="parameter">nom_utilisateur</replaceable></option></term>
     <listitem>
      <para>
       Spécifie le nom d'utilisateur utilisé pour la connexion.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-w</option></term>
     <term><option>--no-password</option></term>
     <listitem>
      <para>
       Ne jamais demander de mot de passe. Si le serveur requiert une
       authentification par mot de passe et qu'aucun mot de passe n'est disponible
       par un autre moyen (par exemple via le fichier <filename>.pgpass</filename>),
       la tentative de connexion échouera. Cette option peut être utile dans les
       scripts ou les traitements de type batch, où aucun utilisateur
       n'est présent pour saisir un mot de passe.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>-W</option></term>
     <term><option>--password</option></term>
     <listitem>
      <para>
       Force <application>pg_restore</application> à demander un mot de passe
       avant la connexion à une base de données.
      </para>

      <para>
       Cette option n'est jamais indispensable car
       <application>pg_restore</application> demande automatiquement un mot de
       passe si le serveur exige une authentification par mot de passe.
       Néanmoins, <application>pg_restore</application> perd une tentative de
       connexion pour tester si le serveur requiert un mot de passe. Dans
       certains cas, il est préférable d'ajouter l'option <option>-W</option>
       pour éviter cette tentative de connexion supplémentaire.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><option>--role=<replaceable class="parameter">nom_rôle</replaceable></option></term>
     <listitem>
      <para>
       Spécifie un rôle à utiliser pour la restauration. Avec cette option,
       <application>pg_restore</application> émet une commande <command>SET
        ROLE</command> <replaceable class="parameter">nom_rôle</replaceable>
       après s'être connecté à la base de données. C'est utile quand l'utilisateur
       authentifié (indiqué par <option>-U</option>) n'a pas les droits dont
       <application>pg_restore</application> a besoin, mais peut basculer vers un
       rôle qui les a. Certaines installations ont une politique qui est
       contre se connecter directement en tant que superutilisateur, et
       l'utilisation de cette option permet aux restaurations de se faire
       sans violer cette politique.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>
 </refsect1>


 <refsect1>
  <title>Environnement</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGOPTIONS</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      Paramètres de connexion par défaut.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><envar>PG_COLOR</envar></term>
    <listitem>
     <para>
      Indique s'il faut utiliser la couleur dans les messages de diagnostic.
      Les valeurs possibles sont <literal>always</literal>,
      <literal>auto</literal>, <literal>never</literal>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Cet outil, comme la plupart des autres outils
   <productname>PostgreSQL</productname>, utilise les variables
   d'environnement supportées par la bibliothèque
   <application>libpq</application> (voir <xref linkend="libpq-envars"/>).
  </para>
 </refsect1>


 <refsect1 id="app-pgrestore-diagnostics">
  <title>Diagnostics</title>

  <para>
   Lorsqu'une connexion directe à la base de données est spécifiée à l'aide de
   l'option <option>-d</option>, <application>pg_restore</application> exécute
   en interne des instructions <acronym>SQL</acronym>. Si vous rencontrez des
   problèmes lors de l'exécution de <application>pg_restore</application>,
   assurez-vous que vous pouvez interroger la base de données,
   par exemple à l'aide de <xref linkend="app-psql"/>.
   Par ailleurs, tous les paramètres de connexion par défaut et variables
   d'environnement utilisés par la bibliothèque cliente
   <application>libpq</application> s'appliquent.
  </para>
 </refsect1>

 <refsect1 id="app-pgrestore-notes">
  <title>Notes</title>

  <para>
   Si votre installation contient des ajouts locaux dans la base de données
   <literal>template1</literal>, veillez à charger la sortie de
   <application>pg_restore</application> dans une base réellement vide&nbsp;;
   dans le cas contraire, vous risquez d'obtenir des erreurs dues à des
   définitions en double des objets ajoutés. Pour créer une base vide sans
   ajouts locaux, copiez-la depuis <literal>template0</literal> plutôt que
   <literal>template1</literal>, par exemple&nbsp;:
   <programlisting>CREATE DATABASE foo WITH TEMPLATE template0;
   </programlisting>
  </para>

  <para>
   Les limitations de <application>pg_restore</application> sont détaillées
   ci-dessous.

   <itemizedlist>
    <listitem>
     <para>
      Lors de la restauration des données dans une table préexistante, si
      l'option <option>--disable-triggers</option> est utilisée,
      <application>pg_restore</application> génère des commandes pour désactiver
      les triggers sur les tables utilisateur avant l'insertion des données,
      puis génère les commandes pour les réactiver après l'insertion.
      Si la restauration est interrompue en cours de traitement, les catalogues
      système pourraient se retrouver dans un état incohérent.
     </para>
    </listitem>

    <listitem>
     <para>
      <application>pg_restore</application> ne peut pas restaurer les « Large
      Objects » de manière sélective, par exemple uniquement ceux associés à
      une table spécifique. Si une archive contient des « Large Objects », alors
      ils seront tous restaurés, ou aucun s'ils sont exclus à l'aide de
      <option>-L</option>, <option>-t</option> ou d'autres options.
     </para>
    </listitem>

   </itemizedlist>
  </para>

  <para>
   Voir aussi la documentation de <xref linkend="app-pgdump"/> pour les
   détails sur les limitations de <application>pg_dump</application>.
  </para>

  <para>
   Par défaut, <command>pg_restore</command> restaure les statistiques de
   l'optimiseur si elles sont incluses dans l'archive. Si toutes les statistiques
   ne sont pas restaurées, il peut être utile d'exécuter
   <command>ANALYZE</command> sur chaque table restaurée afin que l'optimiseur
   dispose de statistiques utiles.
   Voir <xref linkend="vacuum-for-statistics"/> et <xref linkend="autovacuum"/>
   pour plus d'informations.
  </para>

 </refsect1>

 <refsect1 id="app-pgrestore-examples">
  <title>Exemples</title>

  <para>
   Supposons que nous avons exporté une base nommée
   <literal>ma_base</literal> dans un fichier d'archive au format
   personnalisé&nbsp;:

   <screen>
<prompt>$</prompt> <userinput>pg_dump -Fc ma_base &gt; ma_base.dump</userinput>
   </screen>
  </para>

  <para>
   Pour supprimer la base et la re-créer à partir de l'export&nbsp;:

   <screen>
<prompt>$</prompt> <userinput>dropdb ma_base</userinput>
<prompt>$</prompt> <userinput>pg_restore -C -d postgres ma_base.dump</userinput>
   </screen>

   La base nommée avec l'option <option>-d</option> peut être toute base de
   données existante dans l'instance&nbsp;;
   <application>pg_restore</application> l'utilise seulement pour exécuter la
   commande <command>CREATE DATABASE</command> pour
   <literal>ma_base</literal>. Avec <option>-C</option>, les données sont
   toujours restaurées dans la base de données dont le nom apparaît dans
   l'export.
  </para>

  <para>
   Pour charger l'export dans une nouvelle base nommée
   <literal>nouvelle_base</literal>&nbsp;:

   <screen>
<prompt>$</prompt> <userinput>createdb -T template0 nouvelle_base</userinput>
<prompt>$</prompt> <userinput>pg_restore -d nouvelle_base db.dump</userinput>
   </screen>

   Notez que nous n'utilisons pas <option>-C</option> et que nous nous sommes
   connectés directement sur la base à restaurer. De plus, notez que nous
   clonons la nouvelle base à partir de <literal>template0</literal> et non
   pas de <literal>template1</literal>, pour s'assurer qu'elle est vide.
  </para>

  <para>
   Pour réordonner les éléments de la base de données, il est tout d'abord
   nécessaire de générer la table des matières de l'archive&nbsp;:
   <screen><prompt>$</prompt> <userinput>pg_restore -l ma_base.dump &gt; ma_base.liste</userinput>
   </screen>
   Le fichier de liste se compose d'un en-tête et d'une ligne pour chaque élément,
   par exemple&nbsp;:
   <programlisting>;
; Archive created at Mon Sep 14 13:55:39 2009
;     dbname: DBDEMOS
;     TOC Entries: 81
;     Compression: 9
;     Dump Version: 1.10-0
;     Format: CUSTOM
;     Integer: 4 bytes
;     Offset: 8 bytes
;     Dumped from database version: 8.3.5
;     Dumped by pg_dump version: 8.3.8
;
;
; Selected TOC Entries:
;
3; 2615 2200 SCHEMA - public pasha
1861; 0 0 COMMENT - SCHEMA public pasha
1862; 0 0 ACL - public pasha
317; 1247 17715 TYPE public composite pasha
319; 1247 25899 DOMAIN public domain0 pasha
   </programlisting>
   Les points-virgules introduisent un commentaire, et les numéros en début de
   ligne font référence à l'identifiant interne attribué à chaque élément dans l'archive.
  </para>

  <para>
   Les lignes dans le fichier peuvent être commentées, supprimées et
   réordonnées. Par exemple&nbsp;:
   <programlisting>10; 145433 TABLE map_resolutions postgres
;2; 145344 TABLE species postgres
;4; 145359 TABLE nt_header postgres
6; 145402 TABLE species_records postgres
;8; 145416 TABLE ss_old postgres
   </programlisting>
   peut être utilisé en entrée de <application>pg_restore</application> et ne
   restaure que les éléments 10 et 6 dans cet ordre&nbsp;:
   <screen><prompt>$</prompt> <userinput>pg_restore -L mabase.liste mabase.fichier</userinput>
   </screen>
  </para>
 </refsect1>

 <refsect1>
  <title>Voir aussi</title>

  <simplelist type="inline">
   <member><xref linkend="app-pgdump"/></member>
   <member><xref linkend="app-pg-dumpall"/></member>
   <member><xref linkend="app-psql"/></member>
  </simplelist>
 </refsect1>
</refentry>

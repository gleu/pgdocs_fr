<?xml version="1.0" encoding="UTF-8"?>
<chapter id="event-triggers">
 <title>Déclencheurs (triggers) sur évènement</title>

 <indexterm zone="event-triggers">
  <primary>trigger sur évènement</primary>
 </indexterm>

 <para>
  Afin d'améliorer le mécanisme des triggers expliqué dans <xref linkend="triggers"/>,
  <productname>PostgreSQL</productname> fournit également des triggers sur
  évènement. À la différence des triggers normaux, qui sont attachés à une
  seule table et ne capturent que des évènements DML, les triggers sur
  évènements sont globaux sur une base en particulier et sont capables de
  capturer tous les évènements DDL.
 </para>

 <para>
  Comme les triggers normaux, les triggers sur évènement peuvent être écrits
  dans n'importe quel langage procédural qui inclut le support des triggers
  sur évènement, ou en C, mais pas en pur SQL.
 </para>

 <sect1 id="event-trigger-definition">
  <title>Aperçu du fonctionnement des triggers sur évènement</title>

  <para>
   Un trigger sur évènement se déclenche chaque fois que l'évènement qui lui
   est associé se déclenche sur la base qui lui est définie. Pour le moment,
   les seuls évènements supportés sont
   <literal>ddl_command_start</literal>,
   <literal>ddl_command_end</literal>,
   <literal>table_rewrite</literal>
   et <literal>sql_drop</literal>.
   Le support pour des évènements additionnels pourrait être ajouté dans
   des versions ultérieures.
  </para>

  <para>
   L'évènement <literal>ddl_command_start</literal> se déclenche juste avant
   l'exécution d'une commande <literal>CREATE</literal>, <literal>ALTER</literal>,
   <literal>DROP</literal>, <literal>SECURITY LABEL</literal>,
   <literal>COMMENT</literal>, <literal>GRANT</literal> ou
   <literal>REVOKE</literal>. Aucune vérification n'est effectuée sur
   l'existence ou non de l'objet avant de déclencher le trigger sur événement.
   Attention, cet évènement ne se déclenche pas
   pour les commandes DDL visant les objets partagés &mdash; bases de données, rôles,
   et tablespaces &mdash; ou pour les commandes visant les triggers sur évènement
   eux-même. Le mécanisme de trigger sur évènement ne supporte pas ces types
   d'objets.
   <literal>ddl_command_start</literal> se déclenche également juste avant
   l'exécution d'une commande <literal>SELECT INTO</literal>, celle-ci étant
   l'équivalent de <literal>CREATE TABLE AS</literal>.
  </para>

  <para>
   L'évènement <literal>ddl_command_end</literal> se déclenche juste après
   l'exécution de ces même ensembles de commandes. Pour obtenir
   plus de détails sur les opérations <acronym>DDL</acronym> qui
   interviennent, utilisez la fonction renvoyant un ensemble de lignes
   <literal>pg_event_trigger_ddl_commands()</literal> à partir du code du
   trigger répondant à l'événement <literal>ddl_command_end</literal>
   (voir <xref linkend="functions-event-triggers"/>). Notez que le trigger
   est exécuté après les actions qui sont intervenues (mais avant
   les validations de transactions), aussi les catalogues systèmes qui
   peuvent être lus ont déjà été modifiés.
  </para>

  <para>
   L'évènement <literal>sql_drop</literal> se déclenche juste avant le trigger
   sur évènement <literal>ddl_command_end</literal> pour toute opération qui
   supprime des objets de la base. Pour lister les objets qui ont été supprimés,
   utilisez la fontion retournant des ensembles d'objets <literal>pg_event_trigger_dropped_objects()</literal>
   depuis le code du trigger sur évènement <literal>sql_drop</literal>
   (voir <xref linkend="functions-event-triggers"/>). Notez que le trigger est
   exécuté après que les objets aient été supprimés du catalogue système, il
   n'est donc plus possible de les examiner.
  </para>

  <para>
   L'événement <literal>table_rewrite</literal> se déclenche juste
   avant qu'une table soit modifiée par certaines actions des commandes
   <literal>ALTER TABLE</literal> et <literal>ALTER TYPE</literal>. Il
   existe d'autres commandes qui permettent de modifier une table, tel
   que <literal>CLUSTER</literal> et <literal>VACUUM</literal>, mais
   l'événement <literal>table_rewrite</literal> n'est pas déclenché
   pour eux.
  </para>

  <para>
   Les triggers sur évènement (comme les autres fonctions) ne peuvent être
   exécutés dans une transaction annulée. Ainsi, si une commande DDL échoue
   avec une erreur, tout trigger <literal>ddl_command_end</literal> associé
   ne sera pas exécuté. Inversement, si un trigger <literal>ddl_command_start</literal>
   échoue avec une erreur, aucun autre trigger sur évènement ne se déclenchera,
   et aucune tentative ne sera faite pour exécuter la commande elle-même. De
   la même façon, si une commande <literal>ddl_command_end</literal> échoue
   avec une erreur, les effets de la commande DDL seront annulés, comme elles
   l'auraient été dans n'importe quel autre cas où la transaction qui la contient
   est annulée.
  </para>

  <para>
   Pour une liste complète des commandes supportées par le mécanisme des
   triggers sur évènement, voir
   <xref linkend="event-trigger-matrix"/>.
  </para>

  <para>
   Les triggers sur événement sont créés en utilisant la commande <xref
   linkend="sql-createeventtrigger"/>.
   Afin de créer un trigger sur évènement, vous devez d'abord créer une
   fonction avec le type de retour spécial <literal>event_trigger</literal>.
   Cette fonction n'a pas besoin (et ne devrait pas) retourner de valeur&nbsp;; le
   type de retour sert uniquement comme signal pour que la fonction soit
   appelée comme un trigger sur évènement.
  </para>

  <para>
   Si plus d'un trigger sur évènement est défini pour un évènement particulier,
   ils seront déclenchés par ordre alphabétique de leur nom.
  </para>

  <para>
   Une définition de trigger peut également spécifier une condition
   <literal>WHEN</literal> pour que, par exemple, un trigger
   <literal>ddl_command_start</literal> ne soit déclenché que pour des commandes
   particulières que l'utilisateur souhaite intercepter. Une utilisation typique
   de tels triggers serait de restreindre la portée des opérations DDL que les
   utilisateurs peuvent exécuter.
  </para>
 </sect1>

 <sect1 id="event-trigger-matrix">
  <title>Matrice de déclenchement des triggers sur évènement</title>

  <para>
   <xref linkend="event-trigger-by-command-tag"/> liste toutes les commandes
   pour lesquelles les triggers sur évènement sont supportés.
  </para>

  <table id="event-trigger-by-command-tag">
   <title>Support des triggers sur évènement par commande</title>
   <tgroup cols="6">
    <thead>
     <row>
      <entry>Commande</entry>
      <entry><literal>ddl_command_start</literal></entry>
      <entry><literal>ddl_command_end</literal></entry>
      <entry><literal>sql_drop</literal></entry>
      <entry><literal>table_rewrite</literal></entry>
      <entry>Notes</entry>
     </row>
    </thead>
      <tbody>
       <row>
        <entry align="left"><literal>ALTER AGGREGATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER COLLATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER CONVERSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER DOMAIN</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER EXTENSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER FOREIGN DATA WRAPPER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER FOREIGN TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER FUNCTION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER LANGUAGE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER OPERATOR</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER OPERATOR CLASS</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER OPERATOR FAMILY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER POLICY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER SCHEMA</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER SEQUENCE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER SERVER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TEXT SEARCH CONFIGURATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TEXT SEARCH DICTIONARY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TEXT SEARCH PARSER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TEXT SEARCH TEMPLATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TRIGGER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER TYPE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER USER MAPPING</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>ALTER VIEW</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE AGGREGATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>COMMENT</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center">Seulement pour les objets locaux</entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE CAST</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE COLLATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE CONVERSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE DOMAIN</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE EXTENSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE FOREIGN DATA WRAPPER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE FOREIGN TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE FUNCTION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE INDEX</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE LANGUAGE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE OPERATOR</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE OPERATOR CLASS</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE OPERATOR FAMILY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE POLICY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE RULE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE SCHEMA</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE SEQUENCE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE SERVER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TABLE AS</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TEXT SEARCH CONFIGURATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TEXT SEARCH DICTIONARY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TEXT SEARCH PARSER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TEXT SEARCH TEMPLATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TRIGGER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE TYPE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE USER MAPPING</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>CREATE VIEW</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP AGGREGATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP CAST</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP COLLATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP CONVERSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP DOMAIN</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP EXTENSION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP FOREIGN DATA WRAPPER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP FOREIGN TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP FUNCTION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP INDEX</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP LANGUAGE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP OPERATOR</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP OPERATOR CLASS</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP OPERATOR FAMILY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP OWNED</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP POLICY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP RULE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP SCHEMA</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP SEQUENCE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP SERVER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TABLE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TEXT SEARCH CONFIGURATION</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TEXT SEARCH DICTIONARY</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TEXT SEARCH PARSER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TEXT SEARCH TEMPLATE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TRIGGER</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP TYPE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP USER MAPPING</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>DROP VIEW</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>GRANT</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center">Seulement pour les objets locaux</entry>
       </row>
       <row>
        <entry align="left"><literal>IMPORT FOREIGN SCHEMA</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
       <row>
        <entry align="left"><literal>REVOKE</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center">Seulement pour les objets locaux</entry>
       </row>
       <row>
        <entry align="left"><literal>SECURITY LABEL</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center">Seulement pour les objets locaux</entry>
       </row>
       <row>
        <entry align="left"><literal>SELECT INTO</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>X</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"><literal>-</literal></entry>
        <entry align="center"></entry>
       </row>
      </tbody>
   </tgroup>
  </table>
 </sect1>

 <sect1 id="event-trigger-interface">
  <title>Écrire des fonctions trigger sur événement en C</title>

  <indexterm zone="event-trigger-interface">
   <primary>trigger sur événement</primary>
   <secondary>en C</secondary>
  </indexterm>

  <para>
   Cette section décrit les détails bas niveau de l'interface pour une fonction
   trigger sur événement bas niveau. Ces informations sont seulement nécessaires
   si vous écrivez des fonctions triggers sur événement en C. Si vous utilisez
   un langage de plus haut niveau, ces détails sont gérés pour vous. Dans la
   plupart des cas, vous devriez songer sérieusement à utiliser un langage
   procédural avant d'écrire vos triggers sur événement en C. La documentation
   de chaque langage procédurale explique comment écrire un trigger sur événement
   dans ce langage.
  </para>

  <para>
   Les fonctions de trigger sur événement doivent utiliser l'interface du
   gestionnaire de fonctions <quote>version 1</quote>.
  </para>

  <para>
   Quand une fonction est appelée par le gestionnaire de triggers sur événement,
   elle ne reçoit aucun argument normal mais un pointeur <quote>context</quote>
   lui est fourni. Il pointe vers une structure de type
   <structname>EventTriggerData</structname>. Les fonctions C peuvent vérifier
   si elles ont été appelées par le gestionnaire de triggers sur événement en
   exécutant la macro&nbsp;:
   <programlisting>
CALLED_AS_EVENT_TRIGGER(fcinfo)
   </programlisting>
   qui vaut en fait&nbsp;:
   <programlisting>
((fcinfo)-&gt;context != NULL &amp;&amp; IsA((fcinfo)-&gt;context, EventTriggerData))
   </programlisting>
   Si cela renvoie la valeur true, alors il est possible de convertir
   <literal>fcinfo-&gt;context</literal> vers le type <literal>EventTriggerData
    *</literal> et d'utiliser la structure pointée
   <structname>EventTriggerData</structname>. La fonction ne doit
   <emphasis>pas</emphasis> modifier la structure
   <structname>EventTriggerData</structname> ou toute donnée qu'elle fournit.
  </para>

  <para>
   <structname>struct EventTriggerData</structname> est défini dans
   <filename>commands/event_trigger.h</filename>&nbsp;:

   <programlisting>
typedef struct EventTriggerData
{
    NodeTag     type;
    const char *event;      /* event name */
    Node       *parsetree;  /* parse tree */
    const char *tag;        /* command tag */
} EventTriggerData;
   </programlisting>

   dont les membres sont définis ainsi&nbsp;:

   <variablelist>
    <varlistentry>
     <term><structfield>type</structfield></term>
     <listitem>
      <para>
       Always <literal>T_EventTriggerData</literal>.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><structfield>event</structfield></term>
     <listitem>
      <para>
       Décrit l'événement pour lequel la fonction a été appelée. Ce sera soit
       <literal>"ddl_command_start"</literal>, soit <literal>"ddl_command_end"</literal>,
       soit <literal>"sql_drop"</literal>, soit <literal>"table_rewrite"</literal>.
       Voir <xref linkend="event-trigger-definition"/> pour la signification de
       ces événements.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><structfield>parsetree</structfield></term>
     <listitem>
      <para>
       Un pointeur vers l'arbre d'analyse de la commande. Vérifiez le code
       source de PostgreSQL pour les détails. La structure de l'arbre d'analyse
       est sujet à modification sans notification.
      </para>
     </listitem>
    </varlistentry>

    <varlistentry>
     <term><structfield>tag</structfield></term>
     <listitem>
      <para>
       La balise de la commande associée avec l'événement pour lequel le trigger
       sur événement est exécuté, par exemple <literal>"CREATE FUNCTION"</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>

  <para>
   Une fonction trigger sur événement doit renvoyer un pointeur
   <symbol>NULL</symbol> (et <emphasis>pas</emphasis> une valeur SQL NULL,
   autrement dit ne pas configurer <parameter>isNull</parameter> à true).
  </para>
 </sect1>

 <sect1 id="event-trigger-example">
  <title>Un exemple complet de trigger sur événement</title>

  <para>
   Voici un exemple très simple d'une fonction trigger sur événement écrite en
   C. (Les exemples de triggers écrits en langage procédural peuvent être trouvés
   dans la documentation de ces langages procédurals.)
  </para>

  <para>
   La fonction <function>noddl</function> lève une exception à chaque fois
   qu'elle est appelée. La définition du trigger événement associe la fonction
   à l'événement <literal>ddl_command_start</literal>. L'effet est qu'aucune
   commande DDL (à l'exception de celles mentionnées dans <xref
   linkend="event-trigger-definition"/>) ne peut être exécutée.
  </para>

  <para>
   Voici le code source de la fonction trigger&nbsp;:
   <programlisting><![CDATA[
#include "postgres.h"
#include "commands/event_trigger.h"


PG_MODULE_MAGIC;

Datum noddl(PG_FUNCTION_ARGS);

PG_FUNCTION_INFO_V1(noddl);

Datum
noddl(PG_FUNCTION_ARGS)
{
    EventTriggerData *trigdata;

    if (!CALLED_AS_EVENT_TRIGGER(fcinfo))  /* internal error */
        elog(ERROR, "not fired by event trigger manager");

    trigdata = (EventTriggerData *) fcinfo->context;

    ereport(ERROR,
        (errcode(ERRCODE_INSUFFICIENT_PRIVILEGE),
                 errmsg("command \"%s\" denied", trigdata->tag)));

    PG_RETURN_NULL();
}
]]></programlisting>
   </para>

   <para>
    Après avoir compilé le code source (voir <xref linkend="dfunc"/>),
    déclarez la fonction et les triggers&nbsp;:
<programlisting>
CREATE FUNCTION noddl() RETURNS event_trigger
    AS 'noddl' LANGUAGE C;

CREATE EVENT TRIGGER noddl ON ddl_command_start
    EXECUTE PROCEDURE noddl();
   </programlisting>
  </para>

  <para>
   Maintenant vous pouvez tester le bon fonctionnement du trigger&nbsp;:
   <screen>
=# \dy
                     List of event triggers
 Name  |       Event       | Owner | Enabled | Procedure | Tags
-------+-------------------+-------+---------+-----------+------
 noddl | ddl_command_start | dim   | enabled | noddl     |
(1 row)

=# CREATE TABLE foo(id serial);
ERROR:  command "CREATE TABLE" denied
   </screen>
  </para>

  <para>
   Dans ce cas, pour pouvoir activier l'exécution de certaines commandes DDL,
   vous pouvez soit supprimer le trigger sur événement soit le désactiver. Il
   est généralement plus simple de désactiver le trigger pendant la durée de
   la transaction&nbsp;:
   <programlisting>
BEGIN;
ALTER EVENT TRIGGER noddl DISABLE;
CREATE TABLE foo (id serial);
ALTER EVENT TRIGGER noddl ENABLE;
COMMIT;
   </programlisting>
   (Pour rappel, les commandes DDL sur les triggers sur événement ne sont pas
   affectées par les triggers sur événement.)
  </para>
 </sect1>

  <sect1 id="event-trigger-table-rewrite-example">
   <title>Un exemple de trigger sur événement de table modifiée</title>

   <para>
    Grâce à l'événement <literal>table_rewrite</literal>, il est
    possible d'écrire une fonction qui autorise les modifications d'une
    table seulement pendant les heures de maintenance.
   </para>

   <para>
    Ci-dessous un exemple d'implémentation d'une telle règle.
<programlisting>
CREATE OR REPLACE FUNCTION pas_de_modification()
 RETURNS event_trigger
 LANGUAGE plpgsql AS
$$
---
--- Implémentation d'une règle de modification de table:
---  pas de modifications de public.foo, les
---  autres tables peuvent l'être entre 01:00 et 06:00 du matin
---  sauf si elles ont plus de 100 blocs
---
DECLARE
  table_oid oid := pg_event_trigger_table_rewrite_oid();
  heure_courante integer := extract('hour' from current_time);
  pages integer;
  max_pages integer := 100;
BEGIN
  IF pg_event_trigger_table_rewrite_oid() = 'public.foo'::regclass
  THEN
        RAISE EXCEPTION 'Vous n''êtes pas autorisé à modifier la table %',
                        table_oid::regclass;
  END IF;

  SELECT INTO pages relpages FROM pg_class WHERE oid = table_oid;
  IF pages > max_pages
  THEN
        RAISE EXCEPTION 'les modifications ne sont seulement permises que pour les tables ayant un nombre de blocs inférieur à %',
                        max_pages;
  END IF;

  IF heure_courante NOT BETWEEN 1 AND 6
  THEN
        RAISE EXCEPTION 'les modifications sont seulement autorisées entre 01:00 et 06:00 du matin';
  END IF;
END;
$$;

CREATE EVENT TRIGGER pas_de_modifications_permises
                  ON table_rewrite
   EXECUTE PROCEDURE pas_de_modification();
</programlisting>
   </para>
 </sect1>

</chapter>
